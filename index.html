<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Particiones Scanner</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; }
        .page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            height: 100vh;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            /* transition: opacity 0.3s, visibility 0.3s; */ /* Animation removed for a more reliable display:none approach */
        }
        .hidden {
            display: none;
        }

        /* --- Estilos de la Pantalla del Menú --- */
        #menu-page h1 { font-size: 2rem; margin-bottom: 40px; margin-top: 0; }
        .logo {
            max-width: 200px;
            height: auto;
            margin-bottom: 20px;
        }
        .menu-button {
            font-size: 1.3rem;
            padding: 20px;
            width: 90%;
            max-width: 350px;
            margin-bottom: 20px;
            border: none;
            border-radius: 12px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .menu-button:last-child { background-color: #28a745; }

        /* --- Estilos de la Pantalla del Escáner --- */
        #scanner-page h1 { font-size: 1.5rem; }
        #scanInput { font-size: 1.2rem; padding: 15px; width: 100%; max-width: 400px; text-align: center; border: 2px solid #ccc; border-radius: 8px; margin-bottom: 20px; box-sizing: border-box; }
        #scanInput:focus { outline: none; border-color: #007bff; }
        #status { font-size: 1rem; min-height: 24px; font-weight: bold; }
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #555;
        }
    </style>
</head>
<body>

    <div id="menu-page" class="page">
        <img src="logo-particiones.jpg" alt="Logo de la Empresa" class="logo">
        <h1>Particiones Scanner</h1>
        <button class="menu-button" data-mode="ingreso">Escanear Ingreso</button>
        <button class="menu-button" data-mode="despacho">Escanear Despacho</button>
    </div>

    <div id="scanner-page" class="page hidden">
        <button class="back-button" id="go-back">⬅️</button>
        <h1 id="scanner-title"></h1>
        <form id="dataForm" onsubmit="return false;">
            <input type="text" id="scanInput" autofocus autocomplete="off">
        </form>
        <p id="status"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURACIÓN ---
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbztW8E1sTI-nur-J7xt-3pCoAOT_kQKOipsWMVRwSc6235TJGLSnS8QrAOFu72hb_OS1Q/exec';

            // --- REFERENCIAS A ELEMENTOS DEL DOM ---
            const ui = {
                menuPage: document.getElementById('menu-page'),
                scannerPage: document.getElementById('scanner-page'),
                menuButtons: document.querySelectorAll('.menu-button'),
                backButton: document.getElementById('go-back'),
                form: document.getElementById('dataForm'),
                input: document.getElementById('scanInput'),
                status: document.getElementById('status'),
                scannerTitle: document.getElementById('scanner-title'),
            };

            // --- ESTADO DE LA APLICACIÓN ---
            const appState = {
                currentMode: '',
                isSyncing: false,
            };

            // --- LÓGICA DE NAVEGACIÓN ---
            const navigateTo = (page, addToHistory = true) => {
                if (page === 'scanner') {
                    ui.menuPage.classList.add('hidden');
                    ui.scannerPage.classList.remove('hidden');
                    if (addToHistory) {
                        history.pushState({ page: 'scanner' }, 'Scanner', '#scanner');
                    }
                    ui.input.focus();
                    updateScannerUI();
                    updateConnectionStatus();
                } else {
                    ui.scannerPage.classList.add('hidden');
                    ui.menuPage.classList.remove('hidden');
                }
            };

            const updateScannerUI = () => {
                const titles = {
                    ingreso: 'Escanear Ingreso',
                    despacho: 'Escanear Despacho'
                };
                const placeholders = {
                    ingreso: 'Esperando código del producto...',
                    despacho: 'Esperando tarja de despacho...'
                };
                ui.scannerTitle.textContent = titles[appState.currentMode] || 'Escanear';
                ui.input.placeholder = placeholders[appState.currentMode] || '';
            };

            // --- LÓGICA DE CONEXIÓN Y SINCRONIZACIÓN ---
            const getPendingScans = () => JSON.parse(localStorage.getItem('pendingScans')) || [];
            const setPendingScans = (scans) => localStorage.setItem('pendingScans', JSON.stringify(scans));

            const updateStatus = (message, color) => {
                ui.status.textContent = message;
                ui.status.style.color = color;
            };

            const updateConnectionStatus = () => {
                if (appState.isSyncing) return;
                const pendingCount = getPendingScans().length;
                if (navigator.onLine) {
                    updateStatus('En línea', 'green');
                    if (pendingCount > 0) {
                        syncPendingScans();
                    }
                } else {
                    updateStatus(`Sin conexión (${pendingCount} pendientes)`, 'grey');
                }
            };

            const sendData = async (scanObject) => {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Mantenemos no-cors como en el original
                    body: new URLSearchParams({
                        'scannedData': scanObject.value,
                        'scanType': scanObject.type
                    })
                });
                 // Con 'no-cors', no podemos verificar el status de la respuesta.
                 // Asumimos éxito si la solicitud no lanza una excepción (ej. por falta de red).
                 // El manejo de errores se basa en el catch del llamado a sendData.
            };

            const syncPendingScans = async () => {
                if (appState.isSyncing || !navigator.onLine) return;

                let pendingScans = getPendingScans();
                if (pendingScans.length === 0) return;

                appState.isSyncing = true;
                updateStatus(`Sincronizando ${pendingScans.length} escaneos...`, 'orange');

                const initialCount = pendingScans.length;

                // Usamos una copia del array para iterar de forma segura
                for (const scan of [...pendingScans]) {
                    try {
                        await sendData(scan);

                        // Si tiene éxito, lo eliminamos de la lista local usando su timestamp único
                        const currentScans = getPendingScans();
                        const updatedScans = currentScans.filter(s => s.timestamp !== scan.timestamp);
                        setPendingScans(updatedScans);

                        updateStatus(`Sincronizando ${updatedScans.length}/${initialCount}...`, 'orange');
                    } catch (error) {
                        console.error('Fallo la sincronización, se reintentará más tarde:', error);
                        updateStatus(`Error de conexión. ${getPendingScans().length} pendientes.`, 'red');
                        appState.isSyncing = false;
                        return; // Termina el proceso si falla uno para evitar un bucle infinito
                    }
                }

                appState.isSyncing = false;

                if (getPendingScans().length === 0) {
                    updateStatus('¡Sincronizado!', 'green');
                } else {
                    // Si aún quedan, es porque se añadieron nuevos durante la sincronización
                    updateConnectionStatus();
                }

                // Re-evaluar el estado de la conexión después de un par de segundos
                setTimeout(updateConnectionStatus, 2000);
            };

            const saveScanLocally = (scanObject) => {
                const pendingScans = getPendingScans();
                pendingScans.push(scanObject);
                setPendingScans(pendingScans);
                updateStatus(`Guardado localmente (${pendingScans.length} pendiente(s))`, 'blue');
            };

            const handleFormSubmit = async (e) => {
                e.preventDefault();
                const scannedValue = ui.input.value.trim();
                if (!scannedValue) return;

                // Añadimos un timestamp para identificar unívocamente cada escaneo
                const scanObject = { value: scannedValue, type: appState.currentMode, timestamp: new Date().toISOString() };

                ui.input.value = '';
                ui.input.focus();

                if (navigator.onLine) {
                    updateStatus('Enviando...', 'orange');
                    try {
                        await sendData(scanObject);
                        updateStatus(`Enviado: ${scanObject.value}`, 'green');
                        // Intenta sincronizar por si había algo pendiente
                        setTimeout(syncPendingScans, 100);
                    } catch (error) {
                        console.error('Error al enviar, guardando localmente:', error);
                        saveScanLocally(scanObject);
                    }
                } else {
                    saveScanLocally(scanObject);
                }
            };

            // --- INICIALIZACIÓN Y EVENT LISTENERS ---
            const init = () => {
                // Navegación
                ui.menuButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        appState.currentMode = button.getAttribute('data-mode');
                        navigateTo('scanner');
                    });
                });

                ui.backButton.addEventListener('click', () => history.back());
                window.addEventListener('popstate', (event) => {
                    if (!event.state || event.state.page === 'menu') {
                        navigateTo('menu', false);
                    }
                });

                // Lógica de la app
                ui.form.addEventListener('submit', handleFormSubmit);
                window.addEventListener('online', updateConnectionStatus);
                window.addEventListener('offline', updateConnectionStatus);

                // Estado inicial
                history.replaceState({ page: 'menu' }, 'Menú', '#menu');
                updateConnectionStatus();

                // Service Worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/sw.js').then(reg => {
                        console.log('Service Worker registrado.', reg);
                    }).catch(err => {
                        console.error('Fallo en el registro del Service Worker:', err);
                    });
                }
            };

            init();
        });
    </script>
</body>
</html>