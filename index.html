<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Particiones Scanner</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* --- General & Variables --- */
        :root {
            --primary-color: #F99D1C; /* Particiones Orange */
            --secondary-color: #2F241C; /* Particiones Brown */
            --background-color: #FDFDFC;
            --header-background: #FFFFFF;
            --text-color: #2F241C; /* Particiones Brown */
            --subtle-text-color: #8A8A8D;
            --border-color: #EAEAEA;
            --status-syncing: #F99D1C;
            --status-error: #FF3B30;
            --status-success: #34C759;
            --status-offline: #8A8A8D;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            overscroll-behavior-y: contain; /* Prevents pull-to-refresh */
        }

        /* --- Layout & Pages --- */
        .page {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            box-sizing: border-box;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .page.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none; /* Important for preventing interaction */
        }

        /* --- Menu Page --- */
        #menu-page {
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        #menu-page h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 30px;
        }
        .logo {
            max-width: 150px; /* Slightly smaller logo */
            height: auto;
            margin-bottom: 20px;
            border-radius: 22%; /* Squircle shape like iOS icons */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .menu-button {
            font-size: 1.1rem;
            padding: 18px 25px;
            width: 100%;
            max-width: 380px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: var(--header-background);
            color: var(--text-color);
            cursor: pointer;
            text-align: left;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        .menu-button:hover {
            background-color: #FAFAFA;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .menu-button .icon {
            color: var(--primary-color);
            font-size: 1.3rem;
            margin-right: 15px;
        }
         .menu-button .arrow {
            font-size: 1.2rem;
            color: var(--subtle-text-color);
        }


        /* --- Scanner Page --- */
        #scanner-page {
            background-color: var(--background-color);
        }
        .scanner-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: var(--header-background);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .scanner-header h1 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
            text-align: center;
            flex-grow: 1; /* Allows the title to center properly */
        }
        .back-button {
            font-size: 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary-color);
            padding: 5px 10px;
        }
        .scanner-content {
            padding: 30px 20px;
            text-align: center;
        }
        #scanInput {
            font-size: 1.2rem;
            padding: 18px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 25px;
            box-sizing: border-box;
            background-color: var(--header-background);
        }
        #scanInput:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(249, 157, 28, 0.3);
        }
        #status {
            font-size: 1rem;
            min-height: 24px;
            font-weight: 500;
            transition: color 0.3s;
        }
    </style>
</head>
<body>

    <div id="menu-page" class="page">
        <img src="logo-particiones.jpg" alt="Logo de la Empresa" class="logo">
        <h1>Particiones Scanner</h1>
        <button class="menu-button" data-mode="ingreso">
            <div><span class="icon">üì•</span>Escanear Ingreso</div>
            <span class="arrow">‚Ä∫</span>
        </button>
        <button class="menu-button" data-mode="salida">
            <div><span class="icon">‚¨ÖÔ∏èüì¶</span>Escanear Salida</div>
            <span class="arrow">‚Ä∫</span>
        </button>
    </div>

    <div id="scanner-page" class="page hidden">
        <header class="scanner-header">
            <button class="back-button" id="go-back">‚Äπ</button>
            <h1 id="scanner-title"></h1>
        </header>
        <div class="scanner-content">
            <form id="dataForm" onsubmit="return false;">
                <input type="text" id="scanInput" autofocus autocomplete="off">
            </form>
            <p id="status"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURACI√ìN ---
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbztW8E1sTI-nur-J7xt-3pCoAOT_kQKOipsWMVRwSc6235TJGLSnS8QrAOFu72hb_OS1Q/exec';

            // --- REFERENCIAS A ELEMENTOS DEL DOM ---
            const ui = {
                menuPage: document.getElementById('menu-page'),
                scannerPage: document.getElementById('scanner-page'),
                menuButtons: document.querySelectorAll('.menu-button'),
                backButton: document.getElementById('go-back'),
                form: document.getElementById('dataForm'),
                input: document.getElementById('scanInput'),
                status: document.getElementById('status'),
                scannerTitle: document.getElementById('scanner-title'),
            };

            // --- ESTADO DE LA APLICACI√ìN ---
            const appState = {
                currentMode: '',
                isSyncing: false,
                wakeLockSentinel: null,
            };

            // --- L√ìGICA DE NAVEGACI√ìN ---
            const navigateTo = (page, addToHistory = true) => {
                const pageToShow = page === 'scanner' ? ui.scannerPage : ui.menuPage;
                const pageToHide = page === 'scanner' ? ui.menuPage : ui.scannerPage;

                pageToHide.classList.add('hidden');
                pageToShow.classList.remove('hidden');

                if (page === 'scanner') {
                    if (addToHistory) {
                        history.pushState({ page: 'scanner' }, 'Scanner', '#scanner');
                    }
                    ui.input.focus();
                    updateScannerUI();
                    updateConnectionStatus();
                    acquireWakeLock(); // Adquirir el wake lock
                } else {
                    releaseWakeLock(); // Liberar el wake lock
                }
            };

            const updateScannerUI = () => {
                const titles = {
                    ingreso: 'Escanear Ingreso',
                    salida: 'Escanear Salida'
                };
                const placeholders = {
                    ingreso: 'Esperando c√≥digo de producto...',
                    salida: 'Esperando c√≥digo de producto...'
                };
                ui.scannerTitle.textContent = titles[appState.currentMode] || 'Escanear';
                ui.input.placeholder = placeholders[appState.currentMode] || '';
            };

            // --- L√ìGICA DE WAKE LOCK ---
            const acquireWakeLock = async () => {
                if ('wakeLock' in navigator) {
                    try {
                        appState.wakeLockSentinel = await navigator.wakeLock.request('screen');
                        appState.wakeLockSentinel.addEventListener('release', () => {
                            appState.wakeLockSentinel = null;
                        });
                    } catch (err) {
                        console.error(`Error al adquirir Wake Lock: ${err.name}, ${err.message}`);
                    }
                }
            };

            const releaseWakeLock = () => {
                if (appState.wakeLockSentinel) {
                    appState.wakeLockSentinel.release();
                    appState.wakeLockSentinel = null;
                }
            };

            // --- L√ìGICA DE CONEXI√ìN Y SINCRONIZACI√ìN ---
            const getPendingScans = () => JSON.parse(localStorage.getItem('pendingScans')) || [];
            const setPendingScans = (scans) => localStorage.setItem('pendingScans', JSON.stringify(scans));

            const updateStatus = (message, color) => {
                ui.status.textContent = message;
                ui.status.style.color = color;
            };

            const updateConnectionStatus = () => {
                if (appState.isSyncing) return;
                const pendingCount = getPendingScans().length;
                if (navigator.onLine) {
                    updateStatus('En l√≠nea', 'var(--status-success)');
                    if (pendingCount > 0) {
                        syncPendingScans();
                    }
                } else {
                    updateStatus(`Sin conexi√≥n (${pendingCount} pendientes)`, 'var(--status-offline)');
                }
            };

            const sendData = async (scanObject) => {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Mantenemos no-cors como en el original
                    body: new URLSearchParams({
                        'scannedData': scanObject.value,
                        'scanType': scanObject.type
                    })
                });
                 // Con 'no-cors', no podemos verificar el status de la respuesta.
                 // Asumimos √©xito si la solicitud no lanza una excepci√≥n (ej. por falta de red).
                 // El manejo de errores se basa en el catch del llamado a sendData.
            };

            const syncPendingScans = async () => {
                if (appState.isSyncing || !navigator.onLine) return;

                let pendingScans = getPendingScans();
                if (pendingScans.length === 0) return;

                appState.isSyncing = true;
                updateStatus(`Sincronizando ${pendingScans.length} escaneos...`, 'var(--status-syncing)');

                const initialCount = pendingScans.length;

                // Usamos una copia del array para iterar de forma segura
                for (const scan of [...pendingScans]) {
                    try {
                        await sendData(scan);

                        // Si tiene √©xito, lo eliminamos de la lista local usando su timestamp √∫nico
                        const currentScans = getPendingScans();
                        const updatedScans = currentScans.filter(s => s.timestamp !== scan.timestamp);
                        setPendingScans(updatedScans);

                        updateStatus(`Sincronizando ${updatedScans.length}/${initialCount}...`, 'var(--status-syncing)');
                    } catch (error) {
                        console.error('Fallo la sincronizaci√≥n, se reintentar√° m√°s tarde:', error);
                        updateStatus(`Error de conexi√≥n. ${getPendingScans().length} pendientes.`, 'var(--status-error)');
                        appState.isSyncing = false;
                        return; // Termina el proceso si falla uno para evitar un bucle infinito
                    }
                }

                appState.isSyncing = false;

                if (getPendingScans().length === 0) {
                    updateStatus('¬°Sincronizado!', 'var(--status-success)');
                } else {
                    // Si a√∫n quedan, es porque se a√±adieron nuevos durante la sincronizaci√≥n
                    updateConnectionStatus();
                }

                // Re-evaluar el estado de la conexi√≥n despu√©s de un par de segundos
                setTimeout(updateConnectionStatus, 2000);
            };

            const saveScanLocally = (scanObject) => {
                const pendingScans = getPendingScans();
                pendingScans.push(scanObject);
                setPendingScans(pendingScans);
                updateStatus(`Guardado localmente (${pendingScans.length} pendiente(s))`, 'var(--primary-color)');
            };

            const handleFormSubmit = async (e) => {
                e.preventDefault();
                const scannedValue = ui.input.value.trim();
                if (!scannedValue) return;

                // A√±adimos un timestamp para identificar un√≠vocamente cada escaneo
                const scanObject = { value: scannedValue, type: appState.currentMode, timestamp: new Date().toISOString() };

                ui.input.value = '';
                ui.input.focus();

                if (navigator.onLine) {
                    updateStatus('Enviando...', 'var(--status-syncing)');
                    try {
                        await sendData(scanObject);
                        updateStatus(`Enviado: ${scanObject.value}`, 'var(--status-success)');
                        // Intenta sincronizar por si hab√≠a algo pendiente
                        setTimeout(syncPendingScans, 100);
                    } catch (error) {
                        console.error('Error al enviar, guardando localmente:', error);
                        saveScanLocally(scanObject);
                    }
                } else {
                    saveScanLocally(scanObject);
                }
            };

            // --- INICIALIZACI√ìN Y EVENT LISTENERS ---
            const init = () => {
                // Navegaci√≥n
                ui.menuButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        appState.currentMode = button.getAttribute('data-mode');
                        navigateTo('scanner');
                    });
                });

                ui.backButton.addEventListener('click', () => history.back());
                window.addEventListener('popstate', (event) => {
                    if (!event.state || event.state.page === 'menu') {
                        navigateTo('menu', false);
                    }
                });

                // L√≥gica de la app
                ui.form.addEventListener('submit', handleFormSubmit);
                window.addEventListener('online', updateConnectionStatus);
                window.addEventListener('offline', updateConnectionStatus);

                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible' && !ui.scannerPage.classList.contains('hidden')) {
                        acquireWakeLock();
                    }
                });

                // Estado inicial
                history.replaceState({ page: 'menu' }, 'Men√∫', '#menu');
                updateConnectionStatus();

                // Service Worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/sw.js').then(reg => {
                        console.log('Service Worker registrado.', reg);
                    }).catch(err => {
                        console.error('Fallo en el registro del Service Worker:', err);
                    });
                }
            };

            init();
        });
    </script>
</body>
</html>
